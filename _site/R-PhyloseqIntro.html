<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Phyloseq Introduction and Import</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />
<link href="site_libs/ionicons-2.0.1/css/ionicons.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">My Website</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="about.html">
    <span class="ion ion-person"></span>
     
    About
  </a>
</li>
<li>
  <a href="resources.html">Resources</a>
</li>
<li>
  <a href="usearch-analysis.html">USEARCH Analysis</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    QIIME2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="QIIME2-NativeInstall.html">Install</a>
    </li>
    <li>
      <a href="QIIME2-DataImport.html">Data Import</a>
    </li>
    <li>
      <a href="QIIME2-DiversityPhylogeny.html">Diversity and phylogeny</a>
    </li>
    <li>
      <a href="QIIME2-Taxonomy.html">Taxonomy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    R analysis
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="R-PhyloseqIntro.html">Phyloseq Intro</a>
    </li>
    <li>
      <a href="R-AlphaDiversity.html">Alpha Diversity &amp; Seq depth</a>
    </li>
    <li>
      <a href="R-MicrobialComposition.html">Microbial Composition</a>
    </li>
    <li>
      <a href="R-BetaPCoA.html">Beta Diversity and PCoA</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Phyloseq Introduction and Import</h1>

</div>


<div id="phyloseq-and-microbiome-analysis-in-r" class="section level3">
<h3>Phyloseq and Microbiome analysis in R</h3>
<p><strong>Data Import and Exploration</strong> There are a number of packages developed in R that make microbiome analysis easy and produce great figures. There is at times a lot of overlap between this analysis and QIIME - and the choice is yours.</p>
<p>Personally I think that R allows alot more freedom and is more aesthetically pleasing, plus there are lots of things that cannot be done in QIIME that can be done in R. Having said that it does require some knowledge of R, and however this notebook tries to step you through what you need to know.</p>
<p>Two packages in particular are useful for microbiome analysis - the microbiome package builds on phyloseq, and you may find you don’t need the microbiome package.</p>
<p><a href="http://joey711.github.io/phyloseq/">Phyloseq</a> <a href="http://microbiome.github.io/microbiome/">Microbiome</a></p>
<p>As always there is more than one way to do things, this phyloseq import will follow the basic import tutorial, in other words importing files individually to create a phyloseq object. However, you may like to follow their tutorials on the QIIME, or mothur input. I do find that as these programs change over time there can be a delay in updating the latest data import workflow, hence why I have gone with the metheod of phyloseq-ize Data already in R that will work no matter what updates are made to QIIME, usearch or other pipelines you may use.</p>
<p><strong>Libraries</strong></p>
<p>Note: You will need to install the library first if you haven’t already using install.packages</p>
<p>Load the libraries</p>
<pre class="r"><code>library(&quot;phyloseq&quot;)
library(&quot;tidyverse&quot;)
library(&quot;ape&quot;)
library(&quot;plyr&quot;)
library(&quot;readr&quot;)
library(&quot;microbiome&quot;)
library(&quot;lattice&quot;)
library(&quot;colorspace&quot;)
library(&quot;RColorBrewer&quot;)
library(&quot;vegan&quot;)
library(&quot;microbiome&quot;)
library(&quot;jsonlite&quot;)</code></pre>
<p>Remove variables in current environment</p>
<pre class="r"><code>rm(list=ls())</code></pre>
<p>Set working directory</p>
<pre class="r"><code>setwd(&quot;~/tick_meta_analysis/data&quot;)</code></pre>
<p><em>Remember the useful package for data management in <code>[R ProjectTemplate](http://projecttemplate.net/getting_started.html)</code></em></p>
</div>
<div id="importing-data-and-creating-a-physeq-object" class="section level3">
<h3>Importing data and creating a physeq object</h3>
<div class="alert alert-success">
Note: The phyloseq package is very sensitive to file formats and way in which your input files are laid out, so please take the time to read this section carefully.
</div>
<p>Next you can set your working directory and import your OTU table (from the usearch pipeline) and your taxonomy table (from QIIME). I recommend you copy and data the files from your Usearch/QIIME directory output to the data file in the R management directory.</p>
<p><strong>Import OTU table taking note of the following:</strong></p>
<ul>
<li>Rows = taxa (otus) and columns = samples. The sample names should already be matched to your metadata if you following the QIIME analysis to generate a feature table correctly.</li>
<li>Order the OTU column in ascending order to do this you may need to delete the letters ‘OTU’, which can be done in excel with a control-H command.</li>
<li>The first column with the OTU number must then be deleted, this can get confusing so it is best to take this document as a copy so that you do not save over the table with the OTU numbers.</li>
<li>Ensure that the column headings (sample names) are in the same order as what appears in the metadata sheet. In excel you may like to copy and paste the data using the transpose option to order the sample column before reverting it back.</li>
<li>Save as csv file</li>
</ul>
<pre class="r"><code>uparse_otus &lt;- read_csv(&quot;~/tick_meta_analysis/data/otu_table.csv&quot;)
otumat &lt;- as.matrix(uparse_otus)
rownames(otumat) &lt;- paste0(&quot;OTU&quot;, 1:nrow(otumat))
colnames(otumat) &lt;- paste0(&quot;Sample&quot;, 1:ncol(otumat))
otumat</code></pre>
<p><strong>Import the taxonomy table taking note of the following:</strong></p>
<ul>
<li>Rows = taxa and columns = taxa heirachy</li>
<li>The first column with the OTU number must then be deleted, this can get confusing so it is best to take this document as a copy so that you do not save over the table with the OTU numbers.</li>
<li>Save as csv file</li>
</ul>
<pre class="r"><code>colnames(taxmat) &lt;- c(&quot;Kingdom&quot;, &quot;Phylum&quot;, &quot;Class&quot;, &quot;Order&quot;, &quot;Family&quot;, &quot;Genus&quot;, &quot;Species&quot;)
taxonomy &lt;- read_csv(&quot;~/tick_meta_analysis/data/taxonomy.csv&quot;)
taxmat &lt;- as.matrix(taxonomy)
rownames(taxmat) &lt;- rownames(otumat)
colnames(taxmat) &lt;- c(&quot;Kingdom&quot;, &quot;Phylum&quot;, &quot;Class&quot;, &quot;Order&quot;, &quot;Family&quot;, &quot;Genus&quot;, &quot;Species&quot;)
taxmat</code></pre>
<div class="alert alert-success">
<strong>Note</strong> format of the taxonomy table varies depending on which reference database you used. For example in the Greengenes classifer the output taxonomy table formats each taxa as followed: <code>p__Taxa</code> where the letter prefix refers to the heirachy of the taxonomy assignment. You may want to remove this formatting in excel before inputting for aesthetic purposes of the graph outputs. You can do this by using the <code>Control-H</code> command in excel.
</div>
<p>Next we can check the class of the otumat and taxmat objects, they MUST be in matrix format. Then we can great a phyloseq object called physeq from the otu and taxonomy tables and check the sample names.</p>
<pre class="r"><code>class(otumat)
class(taxmat)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
TAX = tax_table(taxmat)
OTU
TAX
physeq = phyloseq(OTU, TAX)
physeq
sample_names(physeq)</code></pre>
<p><strong>Tree Import</strong></p>
<p>There are a few options for the tree import- you can create a random tree using the ape package, however as this only using taxonomy information it is not as robust as other methods that use the sequence information, such as that generated by QIIME or USEARCH.</p>
<pre class="r"><code>random_tree = rtree(ntaxa(physeq), rooted=TRUE, tip.label=taxa_names(physeq))
plot(random_tree)</code></pre>
<p>To import your USEARCH tree</p>
<pre class="r"><code>MyTree &lt;- read.tree(&quot;otus.tree&quot;)</code></pre>
<p>To import your QIIME2 tree</p>
<pre class="r"><code>MyTree2 &lt;- read.tree(&quot;rooted-tree.nwk&quot;)</code></pre>
<p>Now you can merge your data to create a final phyloseq object</p>
<pre class="r"><code>physeq1 = merge_phyloseq(physeq, sampledata, MyTree)
physeq1</code></pre>
<p>You should end up with the following output after <code>physeq1</code></p>
<pre><code>phyloseq-class experiment-level object
otu_table()   OTU Table:         [ 15985 taxa and 1390 samples ]
sample_data() Sample Data:       [ 1390 samples by 13 sample variables ]
tax_table()   Taxonomy Table:    [ 15985 taxa by 7 taxonomic ranks ]
phy_tree()    Phylogenetic Tree: [ 15985 tips and 15984 internal nodes ]</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
